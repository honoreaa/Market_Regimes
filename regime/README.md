# Market Regime Detection on NASDAQ Futures Using Hidden Markov Models (HMM)

---

## 1. Goal

The primary objective of this project is to identify distinct **market regimes** within NASDAQ E-mini futures (`NQ=F`) price data using a **Hidden Markov Model (HMM)**. Market regimes represent different states or environments in which asset prices behave differently, such as trending markets, volatile periods, or stable sideways movements.

By accurately detecting these regimes from historical data, the project aims to:

- Understand the underlying structural shifts in market behavior
- Inform trading strategies by adapting to current regimes
- Reduce risk exposure during unfavorable regimes
- Improve overall performance through regime-aware decision-making

---

## 2. Ideation

Financial markets are inherently non-stationary and characterized by regime changes that affect returns and volatility dynamics. Traditional trading strategies often fail to adapt to these shifts, resulting in suboptimal performance and increased risk.

The idea was to leverage **machine learning**, specifically **unsupervised learning**, to uncover hidden states (regimes) from observed price patterns without requiring predefined labels. The **Hidden Markov Model** is a natural fit because:

- It models time series data as a sequence of observations generated by underlying latent states
- The transition probabilities capture how markets move between regimes over time
- The model learns regime characteristics (mean, variance) directly from features

The project focused on futures contracts, chosen because they are widely traded, liquid, and reflect institutional market views.

---

## 3. Process

The project was divided into distinct phases:

### Data Acquisition

- Historical daily price data for NASDAQ E-mini futures (`NQ=F`) was downloaded from Yahoo Finance covering January 2015 through December 2024.

### Feature Engineering

- Raw prices are not suitable directly for HMMs.
- Two key features were engineered:
  - **Daily Returns:** Percent change of closing price day-over-day, capturing directional movement.
  - **10-day Rolling Volatility:** Standard deviation of returns over a rolling window, measuring market uncertainty.

### Model Training

- A **Gaussian Hidden Markov Model** with three hidden states was trained on the two-dimensional feature space (`returns`, `volatility`).
- The model optimized parameters via Expectation-Maximization to fit observed data sequences.

### Regime Assignment

- Each day was assigned a latent regime label based on model predictions.
- Regimes were then interpreted by analyzing their statistical properties.

### Visualization and Analysis

- Price data was plotted and colored by regime assignment to visually verify segmentation.
- Summary statistics for each regime (mean return, volatility, Sharpe ratio, max drawdown, and duration) were calculated.
- A simple backtest was implemented simulating a strategy that goes long only during the "trending" regime.

---

## 4. Math

### Hidden Markov Model (HMM) Fundamentals

An HMM assumes:

- There is an underlying sequence of hidden states  
  \( S_t \in \{1, 2, \ldots, N\} \)  
  governing market behavior.

- Each hidden state emits observations \( O_t \), here modeled as a continuous Gaussian distribution over the features  
  \( \mathbf{x}_t = [\text{return}_t, \text{volatility}_t] \)

The model parameters include:

- Transition probabilities  
  \[
  A = [a_{ij}], \quad \text{where} \quad a_{ij} = P(S_{t+1} = j \mid S_t = i)
  \]

- Emission parameters for each state \( j \), with mean vector \( \boldsymbol{\mu}_j \) and covariance matrix \( \Sigma_j \)

- Initial state probabilities  
  \[
  \pi = \{\pi_i\}, \quad \pi_i = P(S_1 = i)
  \]

The **Expectation-Maximization (EM)** algorithm estimates these parameters by maximizing the likelihood of the observed data.

---

### Feature Calculations

**Daily Return:**

\[
r_t = \frac{P_t - P_{t-1}}{P_{t-1}}
\]

**Rolling Volatility (window = 10 days):**

\[
\sigma_t = \sqrt{\frac{1}{9} \sum_{i=t-9}^{t} (r_i - \bar{r}_t)^2}
\]

where \( \bar{r}_t \) is the mean return over the window:

\[
\bar{r}_t = \frac{1}{10} \sum_{i=t-9}^t r_i
\]

---

### Cumulative Returns Calculation

For daily simple returns \( r_t \), cumulative returns up to day \( T \) are:

\[
CR_T = \prod_{t=1}^{T} (1 + r_t) - 1
\]


## 5. Output

The project produced:

- **Regime-labelled data:** The original time series enriched with regime assignment for each day.
- **Visualizations:**
  - Price chart with regimes colored distinctly, illustrating how regimes align with market trends and volatility.
  - Bar charts summarizing regime statistics: mean returns, volatility, Sharpe ratios, and maximum drawdowns.
  - Cumulative returns plots comparing buy-and-hold versus regime-based trading strategy performance.

- **Statistical insights:**

| Regime  | Mean Return | Volatility | Sharpe Ratio | Max Drawdown | Duration (days) |
|---------|-------------|------------|--------------|--------------|-----------------|
| 0       | +0.0012     | 0.008      | 0.15         | -0.12        | 300             |
| 1       | -0.0008     | 0.015      | -0.05        | -0.30        | 150             |
| 2       | +0.0003     | 0.004      | 0.07         | -0.06        | 200             |

*(Example values â€” see actual results in `regime_stats.png`)*

- **Backtest:**

A strategy that takes a long position only during the "trending" regime outperformed buy-and-hold by:

- Achieving higher cumulative returns
- Experiencing lower drawdowns
- Demonstrating smoother equity curves

---

## 6. Conclusions

- **HMMs effectively segment markets into meaningful regimes** based on returns and volatility, capturing structural shifts not visible from price alone.

- **Regime awareness is a powerful tool for strategy improvement:**  
  Filtering trades based on regimes can reduce exposure during unfavorable periods and improve risk-adjusted returns.

- **Feature selection is critical:** Using return and volatility as input features provides a balanced view of market direction and risk.

- **Proper backtesting discipline:** Shifting positions to avoid lookahead bias is essential to obtain realistic performance estimates.

- **Extensibility:** This framework can be expanded with additional features, more sophisticated regime definitions, and integration into live trading systems.

- **Final takeaway:**  
  Incorporating regime detection through probabilistic models like HMMs can make trading strategies more adaptive, robust, and ultimately more profitable.

---

# Thank you for exploring this project!  
Feel free to reach out with questions or suggestions.

---

